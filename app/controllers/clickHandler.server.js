'use strict';var Users=require('../models/users.js'),Polls=require('../models/polls.js'),randomColor=function(){return'#'+Math.random().toString(16).substr(-6)};function ClickHandler(){this.getAllPolls=function(a,b){Polls.find({},{title:1}).exec(function(a,c){if(a)throw a;var d='';c.forEach(function(a){d+='<tr><td><a class=\'viewCtrl\' href=\'/poll/'+a._id+'\'><i class=\'fa fa-comments\'></i>&nbsp;&nbsp;'+a.title+'</a></td></tr>'}),b.json(d)})},this.getUserPolls=function(a,b){Polls.find({creator:a.user.github.id},{title:1}).exec(function(a,c){if(a)throw a;var d='';c.forEach(function(a){d+='<tr><td>'+a.title+'</td><td><a class=\'viewCtrl\' href=\'/poll/'+a._id+'\'><i class=\'fa fa-2x fa-eye\'></i></a></td><td><a class=\'delCtrl\' id=\''+a._id+'\' href=\'javascript:;\' onclick=\'tryDel(this)\'><i class=\'fa fa-2x fa-minus-circle\'></i></button></td></tr>'}),b.json(d)})},this.createPoll=function(a,b){var c=new Polls(a.body);c.save().then(function(a,c){return a?b.json(a):b.json(c)})},this.deletePoll=function(a,b,c){Polls.remove({creator:a,_id:b}).exec(function(a,b){if(a)throw a;c.json(b)})},this.addChoice=function(a,b,c){Polls.findOneAndUpdate({_id:a},{$addToSet:{choices:{text:b,votes:0}}}).exec(function(a,b){if(a)throw a;c.json(b)})},this.showPoll=function(a,b){Polls.find({_id:a},{_id:0,__v:0,creator:0,"choices._id":0}).exec(function(a,c){var d=[],f=[];c[0].choices.forEach(function(a){d.push(a.text),f.push(a.votes)});var e={type:'pie',data:{labels:d,datasets:[{data:f,backgroundColor:['#8bcc8e','#46627f','#9083e8','#ff7322','#317f35','#61adff','#80456b','#ffc661','#aeffb2','#ff9d61','#bedda2','#c8849f','#9083e8','#bbe2ae','#ca7f35','#aaaddd','#ddc352','#bbaafe','#c08fca',randomColor(),randomColor(),randomColor(),randomColor(),randomColor(),randomColor()]}]},options:{elements:{arc:{borderColor:'#eee',borderWidth:5}},hover:{animationDuration:700},legend:{labels:{fontSize:16}},tooltips:{bodyFontSize:18},title:{display:!0,fontSize:24,fontColor:'#a03',text:c[0].title}}};if(a)throw a;b.json(e)})},this.vote=function(a,b,c){Polls.findOneAndUpdate({_id:a,"choices.text":b},{$inc:{"choices.$.votes":1}}).exec(function(a,b){if(a)throw a;console.log(b),c.json(b)})}}module.exports=ClickHandler;